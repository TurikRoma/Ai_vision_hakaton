# Руководство для Frontend-разработчика по интеграции с Backend API

## Введение

Этот документ — ваш основной гайд по настройке фронтенд-приложения и взаимодействию с бэкенд API нашего проекта. Здесь вы найдете информацию о настройке переменных окружения, описание всех доступных эндпоинтов, сценарии аутентификации и примеры кода.

**Базовый URL API:** `http://localhost:8000/` (или ваш URL для продакшена).

---

## 1. Настройка окружения

Для безопасного хранения ключей и других конфигурационных данных мы используем `.env` файлы.

1.  **Создайте файл:** В корневой директории `frontend` создайте файл с названием `.env.local`.

2.  **Добавьте переменные:** Откройте файл и добавьте в него следующие переменные.

    ```env
    # URL вашего бэкенд-сервера
    VITE_API_BASE_URL=http://localhost:8000/api/v1

    # Внутренний ключ API для анонимных запросов
    VITE_INTERNAL_API_KEY=
    ```

    **Важно:** Поскольку мы используем Vite, все переменные окружения, которые должны быть доступны в клиентском коде, **обязательно** должны начинаться с префикса `VITE_`.

3.  **Добавьте `.env.local` в `.gitignore`:** Убедитесь, что этот файл не попадет в репозиторий, так как он содержит секретные данные.

4.  **Использование в коде:** Теперь вы можете получить доступ к этим переменным в вашем коде следующим образом:

    ```javascript
    const apiBaseUrl = import.meta.env.VITE_API_BASE_URL;
    const internalApiKey = import.meta.env.VITE_INTERNAL_API_KEY;
    ```

---

## 2. API Эндпоинты

Ниже приведено подробное описание всех эндпоинтов, сгруппированных по функциональности.

### 2.1 Аутентификация (`/auth`)

Эти эндпоинты отвечают за регистрацию, вход и управление сессией пользователя.

#### **Регистрация**

- **Метод:** `POST`
- **URL:** `/auth/signup`
- **Описание:** Создает нового пользователя и в случае успеха возвращает `access_token` и устанавливает `refresh_token` в `HttpOnly` cookie.
- **Заголовки:**
  - `Content-Type: application/json`
- **Тело запроса (JSON):**

  ```json
  {
    "email": "user@example.com",
    "password": "yourstrongpassword"
  }
  ```

- **Пример ответа (200 OK):**

  ```json
  {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "bearer"
  }
  ```

#### **Вход (Логин)**

- **Метод:** `POST`
- **URL:** `/auth/login`
- **Описание:** Аутентифицирует пользователя и возвращает `access_token`, устанавливая `refresh_token` в cookie.
- **Тело запроса (JSON):**

  ```json
  {
    "email": "user@example.com",
    "password": "yourstrongpassword"
  }
  ```

- **Пример ответа (200 OK):**

  ```json
  {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "bearer"
  }
  ```

#### **Обновление токена**

- **Метод:** `POST`
- **URL:** `/auth/refresh`
- **Описание:** Использует `refresh_token` из cookie для получения нового `access_token`. Этот эндпоинт нужно вызывать, когда `access_token` истек (бэкенд вернул ошибку 401).
- **Тело запроса:** Пустое. `refresh_token` отправляется автоматически из cookie.
- **Пример ответа (200 OK):**

  ```json
  {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "bearer"
  }
  ```

#### **Выход**

- **Метод:** `POST`
- **URL:** `/auth/logout`
- **Описание:** Удаляет `refresh_token` на бэкенде и из cookie.
- **Тело запроса:** Пустое.
- **Пример ответа (200 OK):**

  ```json
  {
    "message": "Successfully logged out"
  }
  ```

### 2.2 Анализы (`/analyses`)

Эти эндпоинты предназначены для работы с анализами изображений.

#### **Создание анализа (анонимно или авторизованно)**

- **Метод:** `POST`
- **URL:** `/analyses/`
- **Описание:** Загружает файл для анализа. Может использоваться как анонимным пользователем, так и авторизованным.
- **Заголовки:**
  - `X-API-Key: {VITE_INTERNAL_API_KEY}` - **Обязателен для всех запросов на создание!**
  - `Authorization: Bearer {access_token}` - **Опционально.** Если пользователь залогинен, передайте этот заголовок, и анализ сразу будет привязан к его аккаунту.
- **Тело запроса:** `FormData`.

  ```javascript
  const formData = new FormData();
  formData.append("file", fileObject); // fileObject - это файл из <input type="file">
  ```

- **Пример ответа (200 OK):**

  ```json
  {
    "id": 1,
    "image_path": "http://minio_url/bucket/filename.jpg",
    "result": null, // результат будет добавлен позже
    "created_at": "2023-10-27T10:00:00.000Z",
    "owner_id": 123 // или null, если запрос был анонимным
  }
  ```

#### **Получение списка анализов пользователя**

- **Метод:** `GET`
- **URL:** `/analyses/`
- **Описание:** Возвращает список всех анализов, привязанных к текущему пользователю. **Требует аутентификации.**
- **Заголовки:**
  - `Authorization: Bearer {access_token}` - **Обязателен.**
- **Пример ответа (200 OK):**

  ```json
  [
    {
      "id": 1,
      "image_path": "...",
      "result": { "key": "value" },
      "created_at": "...",
      "owner_id": 123
    },
    {
      "id": 2,
      "image_path": "...",
      "result": null,
      "created_at": "...",
      "owner_id": 123
    }
  ]
  ```

#### **Привязка анонимного анализа к пользователю**

- **Метод:** `PATCH`
- **URL:** `/analyses/{analysis_id}/assign`
- **Описание:** Привязывает ранее созданный анонимный анализ к текущему аутентифицированному пользователю. **Требует аутентификации.**
- **Заголовки:**
  - `Authorization: Bearer {access_token}` - **Обязателен.**
- **Параметры URL:**
  - `analysis_id`: ID анализа, который вы получили при его создании в анонимном режиме.
- **Пример ответа (200 OK):**

  ```json
  {
    "id": 1,
    "image_path": "...",
    "result": null,
    "created_at": "...",
    "owner_id": 123 // ID текущего пользователя
  }
  ```

---

## 3. Сценарии использования (Flows)

### 3.1 Полный цикл аутентификации

1.  **Регистрация/Вход:** Пользователь вводит данные, вы отправляете запрос на `/auth/signup` или `/auth/login`.
2.  **Сохранение токена:** В ответ вы получаете `access_token`. Сохраните его в состоянии вашего приложения (например, в React Context, Redux, Zustand).
3.  **Отправка токена:** При каждом запросе к защищенным эндпоинтам (`/analyses/`, `/analyses/{id}/assign` и т.д.) добавляйте заголовок `Authorization: Bearer {access_token}`.
4.  **Обработка истекшего токена:** Если API возвращает ошибку `401 Unauthorized`, это значит, что `access_token` истек.
5.  **Обновление токена:** В этот момент автоматически (без участия пользователя) отправьте запрос на `/auth/refresh`.
6.  **Повтор запроса:** В случае успеха вы получите новый `access_token`. Сохраните его, заменив старый, и повторите изначальный запрос, который не удался.
7.  **Выход:** При выходе из системы вызовите `/auth/logout` и очистите `access_token` из состояния вашего приложения.

### 3.2 Сценарий анонимного анализа

Это ключевой флоу для новых пользователей.

1.  **Загрузка изображения:** Пользователь (незалогиненный) выбирает и загружает изображение на главной странице.
2.  **Отправка на анализ:** Вы отправляете `POST` запрос на `/analyses/`.
    - **Обязательно** включаете заголовок `X-API-Key` с вашим ключом из `.env.local`.
    - **Не включаете** заголовок `Authorization`.
3.  **Сохранение ID:** Бэкенд создает "анонимный" анализ (`owner_id` будет `null`) и возвращает его данные. **Самое важное — сохранить `id` этого анализа** (например, в `localStorage` или в состоянии приложения).
4.  **Пользователь решает сохранить:** После получения результата анализа, пользователь нажимает кнопку "Сохранить в аккаунт".
5.  **Проверка авторизации:**
    - Если пользователь уже залогинен, переходите к шагу 7.
    - Если нет, показываете ему модальное окно/страницу для входа или регистрации.
6.  **Логин/Регистрация:** Пользователь успешно входит в систему, и вы получаете его `access_token`.
7.  **Привязка анализа:** Теперь вы делаете `PATCH` запрос на `/analyses/{analysis_id}/assign`:
    - Используйте `analysis_id`, который вы сохранили на шаге 3.
    - Включите заголовок `Authorization: Bearer {access_token}`.
8.  **Готово!** Анализ теперь привязан к аккаунту пользователя, и он сможет увидеть его в своем личном кабинете. Очистите `analysis_id` из временного хранилища.

---
