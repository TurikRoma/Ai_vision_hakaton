# Пошаговый план разработки Backend

Этот документ описывает последовательность шагов, по которым мы будем двигаться при разработке нашего приложения для компьютерного зрения.

### Этап 1: Настройка окружения и базовой структуры

1.  **Настройка виртуального окружения и установка зависимостей.**
    - Создание локального виртуального окружения (`venv` или `conda`).
    - Установка всех пакетов, перечисленных в `requirements.txt`.
2.  **Настройка конфигурации приложения.**
    - Реализация в `app/core/config.py` чтения настроек (данные для подключения к БД, секретный ключ для JWT) из переменных окружения (`.env` файл).
3.  **Инициализация Alembic для миграций.**
    - Настройка `Alembic` для работы с нашей асинхронной базой данных и моделями.

### Этап 2: Реализация моделей и базы данных

1.  **Определение моделей SQLAlchemy.**
    - В файле `app/db/models.py` опишем три основные модели: `User`, `Analysis` и `RefreshToken` со всеми согласованными полями.
2.  **Создание сессии БД.**
    - В `app/db/session.py` настроим асинхронную сессию для взаимодействия с PostgreSQL.
3.  **Первая миграция.**
    - С помощью `Alembic` создадим и применим первую миграцию, которая сгенерирует соответствующие таблицы в базе данных.

### Этап 3: Аутентификация и безопасность

1.  **Создание Pydantic-схем.**
    - Опишем схемы для пользователя (`schemas/user.py`) и токенов (`schemas/token.py`). Это "контракты" нашего API для валидации входящих и исходящих данных.
2.  **Реализация утилит безопасности.**
    - В `app/core/security.py` добавим функции:
      - Для хеширования и проверки паролей (`passlib`).
      - Для создания `access` и `refresh` JWT токенов.
      - Для хеширования refresh-токенов перед записью в БД (SHA-256).
3.  **Создание эндпоинтов аутентификации.**
    - В `app/api/endpoints/auth.py` реализуем:
      - Регистрацию нового пользователя (`/signup`).
      - Вход пользователя (`/login`), который возвращает `access_token` и `refresh_token` (в httpOnly cookie).
      - Обновление токенов (`/refresh`), используя `refresh_token`.
      - Выход из системы (`/logout`), который отзывает `refresh_token`.

### Этап 4: Основной функционал (Анализы)

1.  **Создание Pydantic-схем для анализов.**
    - Опишем схемы в `app/schemas/analysis.py` для создания и отображения результатов анализа.
2.  **Реализация эндпоинтов для работы с анализами.**
    - В `app/api/endpoints/analyses.py` создадим защищенные эндпоинты:
      - `POST /analyses/` — для загрузки фотографии, ее сохранения и создания записи в БД. На этом этапе интеграцию с ML-моделью можно сделать в виде "заглушки".
      - `GET /analyses/` — для получения списка всех анализов текущего пользователя.
      - `GET /analyses/{analysis_id}` — для получения детальной информации по одному анализу.

### Этап 5: Сборка и финальная настройка

1.  **Объединение роутеров.**
    - В `app/api/api.py` импортируем и объединим роутеры из `auth.py` и `analyses.py`.
2.  **Главный файл приложения.**
    - В `app/main.py` создадим экземпляр FastAPI, подключим главный роутер и настроим CORS (если потребуется).
3.  **Тестирование.**
    - Проведем полное тестирование всех эндпоинтов через автоматически сгенерированную документацию Swagger UI (`/docs`).

### Этап 6: Контейнеризация (Будущие задачи)

1.  **Написание Dockerfile.**
    - Подготовка `Dockerfile` для сборки production-ready образа нашего приложения.
2.  **Написание docker-compose.yml.**
    - Создание `docker-compose.yml` для удобного запуска всего стека (приложение + база данных PostgreSQL) одной командой.

---

Этот план поможет нам двигаться последовательно и ничего не упустить. Мы можем начинать с первого этапа, как только вы будете готовы.
